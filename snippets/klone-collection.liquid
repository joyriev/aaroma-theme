{% liquid
  assign gift_product = all_products['gift-bag']
  assign bundle_collection = collections['top-sellers']
  assign chosen_product = all_products['dark-mystique-collection']
  assign chosen_variant = chosen_product.variants.first

  for variant in chosen_product.variants
    if variant.title == '50ML'
      assign chosen_variant = variant
    endif
  endfor
%}

<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<div class="[display:grid] grid-cols-2 gap-4 pt-4">
  <div class="flex items-center gap-2">
    <div class="size-6 [&>svg]:fill-[#96743f]">
      {{ 'icon-stopwatch.svg' | inline_asset_content }}
    </div>
    <div class="text-sm md:text-lg font-semibold text-black">Long Lasting</div>
  </div>
  <div class="flex items-center gap-2">
    <div class="size-6 [&>svg]:fill-[#96743f]">
      {{ 'icon-price-tag.svg' | inline_asset_content }}
    </div>
    <div class="text-sm md:text-lg font-semibold text-black">At Fraction Cost</div>
  </div>
</div>

<div class="text-center relative pt-6 !mb-6 border-0 border-b border-gray-200 border-solid">
  <span class="bg-[#ffffff] absolute left-1/2 [transform:translateX(-50%)] -bottom-4 font-semibold text-nowrap text-black">ðŸŽ‰ New Year New Me ðŸŽ‰</span>
</div>

<div x-data class="flex flex-col gap-2">
  <button
    @click="$store.bundle.setPackage('buy_1')"
    class="border-[3px] border-solid cursor-pointer p-3 flex gap-4 bg-white rounded-xl"
    :class="$store.bundle.package === 'buy_1' ? 'border-[#96743f]' : 'border-gray-300'">
    <div class="shrink-0 size-6 flex items-center justify-center rounded-full border-2 border-solid" :class="$store.bundle.package === 'buy_1' ? 'border-[#96743f]' : 'border-gray-300'">
      <span
        x-show="$store.bundle.package === 'buy_1'"
        class="block size-4 rounded-full bg-[#96743f]"
        style="display: none;"></span>
    </div>
    <div class="space-y-1 flex-1">
      <div class="flex items-center justify-between">
        <h3 class="my-0 text-xl font-semibold">Buy One</h3>
        <div class="text-xl font-semibold shrink-0">
          {{ chosen_variant.price | money }}
        </div>
      </div>
      <div class="mt-1" x-show="$store.bundle.package === 'buy_1'">
        <select
          @change="$store.bundle.updateVariant('buy_1', 0, $event.target.value)"
          :value="$store.bundle.variants.buy_1[0]"
          class="px-2 py-2 w-full border border-gray-200 rounded border-solid block focus:ring-0 focus:outline-none focus:shadow-none"
          name="buy_one">
          {% for product in bundle_collection.products %}
            {% liquid
              assign variant = product.variants.first
              assign nuta_list = product.metafields.custom.nuta | split: ','
              for variant in product.variants
                if variant.title == '50ML'
                  assign variant = variant
                endif
              endfor
            %}
            <option value="{{ variant.id }}">...{{ nuta_list[1] }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </button>

  <button
    @click="$store.bundle.setPackage('buy_2_get_1_free')"
    class="border-[3px] border-solid cursor-pointer p-3 flex gap-4 bg-white rounded-xl"
    :class="$store.bundle.package === 'buy_2_get_1_free' ? 'border-[#96743f]' : 'border-gray-300'">
    <div class="shrink-0 size-6 flex items-center justify-center rounded-full border-2 border-solid" :class="$store.bundle.package === 'buy_2_get_1_free' ? 'border-[#96743f]' : 'border-gray-300'">
      <span
        x-show="$store.bundle.package === 'buy_2_get_1_free'"
        class="block size-4 rounded-full bg-[#96743f]"
        style="display: none;"></span>
    </div>
    <div class="flex-1 space-y-1">
      <div class="flex items-center justify-between">
        <h3 class="my-0 text-xl font-semibold">
          Buy 2 Get 1 Free
        </h3>
        <div class="text-xl font-semibold shrink-0">
          {{ chosen_variant.price | times: 2 | money }}
        </div>
      </div>
      <p class="my-0 text-base text-left">
        You Save {{ chosen_variant.price | money }}
      </p>
      <div x-show="$store.bundle.package === 'buy_2_get_1_free'" class="space-y-1">
        <template x-for="(variant, index) in $store.bundle.variants.buy_2_get_1_free" :key="index">
          <select
            @change="$store.bundle.updateVariant('buy_2_get_1_free', index, $event.target.value)"
            :value="variant"
            class="px-2 py-2 w-full border border-gray-200 rounded border-solid block focus:ring-0 focus:outline-none focus:shadow-none">
            {% for product in bundle_collection.products %}
              {% liquid
                assign selected_variant = product.variants.first
                assign nuta_list = product.metafields.custom.nuta | split: ','
                for v in product.variants
                  if v.title == '50ML'
                    assign selected_variant = v
                    break
                  endif
                endfor
              %}
              <option value="{{ selected_variant.id }}">...{{ nuta_list[1] }}</option>
            {% endfor %}
          </select>
        </template>
      </div>
    </div>
  </button>

  <div class="pt-6 relative">
    <div class="absolute top-0 right-2 text-white text-xs leading-snug px-2 py-1 uppercase bg-[#96743f] font-semibold">Best Value</div>
    <button
      @click="$store.bundle.setPackage('buy_3_get_2_free')"
      class="border-[3px] border-solid cursor-pointer p-3 flex gap-4 bg-white w-full rounded-xl"
      :class="$store.bundle.package === 'buy_3_get_2_free' ? 'border-[#96743f]' : 'border-gray-300'">
      <div class="shrink-0 size-6 flex items-center justify-center rounded-full border-2 border-solid" :class="$store.bundle.package === 'buy_3_get_2_free' ? 'border-[#96743f]' : 'border-gray-300'">
        <span x-show="$store.bundle.package === 'buy_3_get_2_free'" class="block size-4 rounded-full bg-[#96743f]"></span>
      </div>
      <div class="flex-1 space-y-1">
        <div class="flex items-center justify-between">
          <h3 class="my-0 text-xl font-semibold">Buy 3 Get 2 Free
          </h3>
          <div class="text-xl font-semibold shrink-0">
            {{ chosen_variant.price | times: 3 | money }}
          </div>
        </div>
        <p class="my-0 text-base text-left">
          You Save {{ chosen_variant.price | times: 2 | money }}
        </p>
        <div x-show="$store.bundle.package === 'buy_3_get_2_free'" class="space-y-1">
          <template x-for="(variant, index) in $store.bundle.variants.buy_3_get_2_free" :key="index">
            <select
              @change="$store.bundle.updateVariant('buy_3_get_2_free', index, $event.target.value)"
              :value="variant"
              class="px-2 py-2 w-full border border-gray-200 rounded border-solid block focus:ring-0 focus:outline-none focus:shadow-none">
              {% for product in bundle_collection.products %}
                {% liquid
                  assign selected_variant = product.variants.first
                  assign nuta_list = product.metafields.custom.nuta | split: ','
                  for v in product.variants
                    if v.title == '50ML'
                      assign selected_variant = v
                      break
                    endif
                  endfor
                %}
                <option value="{{ selected_variant.id }}">...{{ nuta_list[1] }}</option>
              {% endfor %}
            </select>
          </template>
        </div>
      </div>
    </button>
  </div>

  <div class="flex items-center gap-3 p-3 border border-solid border-gray-200 rounded-xl bg-white mt-4">
    <input
      type="checkbox"
      id="gift-bag"
      x-model="$store.bundle.addGiftBag"
      class="!size-5 cursor-pointer accent-[#96743f] border-gray-300 rounded">
    <label for="gift-bag" class="flex items-center gap-4 cursor-pointer flex-1">
      <img
        src="{{ gift_product.featured_image | image_url: width: 100 }}"
        alt="Gift Bag"
        height="64"
        width="64"
        class="size-16 object-cover rounded-md bg-gray-100">
      <div>
        <div class="text-base font-semibold">Add:
          <span class="font-bold">Gift Bag</span>
        </div>
        <div class="text-base font-semibold">{{ gift_product.price | money }}</div>
      </div>
    </label>
  </div>

  <button
    :disabled="$store.bundle.addingToCart"
    @click="$store.bundle.addToCart()"
    class="w-full flex flex-wrap items-center text-2xl py-3 rounded-xl button bg-[#96743f] transition-colors shadow-xl tracking-normal mt-4">
    Add to Cart
    <div x-show="$store.bundle.addingToCart" class="loading__spinner">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="spinner"
        viewBox="0 0 66 66">
        <circle
          stroke-width="6"
          cx="33"
          cy="33"
          r="30"
          fill="none"
          class="path"></circle>
      </svg>
    </div>
  </button>
</div>

<div class="!my-6">
  <p class="my-0 text-center font-semibold tracking-normal">
    Delivered to <span class="shipping_location">Worldwide</span> in 5 business days. No customs fees.
  </p>
</div>

<div class="flex justify-center gap-2">
  {% assign enabled_payment_types = 'visa,master,american_express,paypal,klarna,google_pay,apple_pay,shopify_pay' | remove: ' ' | split: ','
  %}
  {% for type in enabled_payment_types %}
    {{ type | payment_type_svg_tag: class: 'icon icon--full-color payment-icon-inline' }}
  {% endfor %}
</div>

<ul class="bg-[#faf6f5] p-4 icon-with-text icon-with-text--vertical list-unstyled">
   <li class="icon-with-text__item">
      <span class="size-8 inline-flex justify-center items-center mr-3">
         <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-accordion icon-price-tag" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="m1.162 11.842 6.93 6.987c.198.2.52.2.717 0l10.03-10.143a.5.5 0 0 0 .148-.36V1.531a.51.51 0 0 0-.507-.51h-7.093a.5.5 0 0 0-.358.15L1.162 11.12a.514.514 0 0 0 0 .722M20 1.532C20 .686 19.32 0 18.48 0h-7.093c-.403 0-.79.162-1.075.449L.445 10.398a1.54 1.54 0 0 0 0 2.167l6.93 6.986a1.51 1.51 0 0 0 2.151-.001l10.03-10.143A1.54 1.54 0 0 0 20 8.325z"></path>
            <path d="M15.903 8.23a2.86 2.86 0 0 1-4.066 0 2.915 2.915 0 0 1 0-4.1 2.86 2.86 0 0 1 4.066 0 2.915 2.915 0 0 1 0 4.1m-3.35-.723a1.85 1.85 0 0 0 2.633 0 1.89 1.89 0 0 0 0-2.654 1.85 1.85 0 0 0-2.633 0 1.89 1.89 0 0 0 0 2.654"></path>
         </svg>
      </span>
      <span class="text-base inline-richtext"><strong class="font-bold font-sans">Luxury Scent. Without Luxury Prices</strong> â€” Smell like the original without overpaying</span>
   </li>
   <li class="icon-with-text__item">
      <span class="size-8 inline-flex justify-center items-center mr-3">
         <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-accordion icon-perfume" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M14.342 4.011c-.357-.276-1.68-.253-3.011-.229a63 63 0 0 1-1.101.013c-.344 0-.713-.009-1.087-.018-1.242-.03-2.53-.062-3.078.234-2.583 1.395-4.267 4.505-4.267 7.572 0 3.135 1.826 5.857 4.504 7.225a8.6 8.6 0 0 0 3.928.937 8.6 8.6 0 0 0 3.927-.937c2.679-1.368 4.504-4.09 4.504-7.225 0-3.067-1.736-6.177-4.32-7.572m-.543.844a2 2 0 0 0-.196-.035 8 8 0 0 0-.897-.05c-.436-.005-.872.003-1.324.011-.37.007-.751.014-1.152.014-.357 0-.738-.01-1.109-.018l-.094-.002c-.406-.01-.798-.019-1.163-.016a8 8 0 0 0-.933.049 2 2 0 0 0-.293.052 1 1 0 0 0-.098.031c-2.22 1.2-3.742 3.946-3.742 6.692 0 2.733 1.59 5.125 3.959 6.334a7.6 7.6 0 0 0 3.473.828c1.257 0 2.438-.3 3.472-.828 2.369-1.209 3.96-3.601 3.96-6.334 0-2.734-1.565-5.488-3.795-6.692zM6.54 4.89"></path>
            <path fill-rule="evenodd" d="M10.72 1.189h-.98a1 1 0 0 0-1 1v1.564h2.98V2.189a1 1 0 0 0-1-1m-.98-1a2 2 0 0 0-2 2v2.564h4.98V2.189a2 2 0 0 0-2-2z"></path>
            <path d="m13.461 8.96.056.001.055.002.055.003.054.004.055.006.054.006.054.007.054.009.053.01.053.01.053.01.052.013.052.013.051.013.05.015.051.015.05.016.05.016.048.017.048.018.048.018.048.019.047.019.046.019.046.02.046.02.045.02.045.02.045.021.044.021.043.021.043.022.043.02.043.022.042.021.042.021.04.021.123.063.118.06.002.001.037.019h.002l.036.02h.002l.036.018.003.001.035.017.003.002.034.016.003.002.034.016.003.002.035.016.036.017.036.016.035.015.035.015.035.015.034.014.033.013.033.013.033.012.032.01.032.012.03.01.031.009.03.009.03.008.03.007.029.007.028.006.028.006.028.005.027.004.027.004.027.003.026.003.026.002.026.001.026.001h.104l.026-.003.026-.002.027-.002.027-.004.027-.004.027-.004.028-.005.028-.006.028-.006.03-.007L17 9.95l.03-.009.03-.008.03-.01.032-.01.031-.01.033-.012.032-.012.034-.013.033-.013.034-.014.035-.015.035-.015.035-.015.036-.017.038-.017.033-.016.003-.001.034-.017.003-.001.035-.017.003-.001.035-.017.002-.002.036-.018h.002l.037-.019h.002l.037-.02h.001l.038-.02.041-.02.627.891-.04.02-.043.022-.041.021h-.002l-.04.021-.003.001-.04.02-.003.002-.043.021-.044.021-.044.021-.045.021-.045.021-.046.02-.045.021-.047.02-.047.02-.047.02-.047.018-.049.019-.048.017-.05.018-.049.017-.05.016-.05.015-.052.015-.051.014-.052.013-.052.012-.053.012-.053.01-.054.01-.054.009-.054.007-.054.007-.055.005-.055.005-.055.003-.055.002-.055.001h-.111l-.055-.003-.055-.004-.054-.004-.055-.006-.054-.007-.054-.007-.054-.009-.053-.01-.053-.01-.052-.012-.052-.012-.052-.013-.05-.014-.051-.015-.05-.015-.05-.016-.05-.017-.048-.017-.048-.018-.048-.018-.047-.019-.047-.019-.047-.02-.046-.02-.045-.02-.045-.02-.045-.02-.044-.021-.044-.021-.044-.021-.04-.02-.003-.002-.04-.02h-.002l-.041-.021h-.002l-.04-.021-.002-.001-.04-.02-.083-.043-.04-.021-.12-.061-.039-.02h-.002l-.037-.02h-.002l-.036-.018-.002-.002-.036-.017-.002-.001-.035-.017-.003-.002-.034-.016-.004-.002-.033-.016-.004-.002-.034-.016-.036-.016-.036-.016-.035-.015-.035-.015-.034-.015-.034-.013-.033-.013-.033-.013-.033-.011-.032-.011-.031-.011-.031-.01-.03-.009-.03-.008-.03-.008-.03-.008-.028-.006-.029-.006-.027-.005-.028-.005-.027-.005-.027-.003-.027-.003-.026-.003-.026-.002h-.026L13.477 10h-.078l-.026.002-.026.002-.026.002-.027.003-.027.004-.027.004-.027.004-.028.006-.029.006-.028.006-.03.007-.029.008-.03.008-.03.01-.031.009-.031.01-.032.011-.033.012-.032.012-.034.013-.033.013-.035.014-.034.015-.035.015-.036.016-.036.017-.034.016-.004.002-.033.015-.004.002-.033.016-.004.002-.034.017h-.003l-.035.018-.003.002-.036.017-.002.002-.037.018h-.001l-.038.02h-.001l-.039.02-.161.083-.042.021-.041.021h-.001l-.04.021-.003.001-.042.022-.043.021-.044.021-.043.022-.045.02-.044.022-.045.02-.046.021-.046.02-.046.02-.047.02-.047.02-.048.019-.048.018-.048.018-.05.017-.049.017-.05.016-.05.016-.051.015-.052.014-.052.013-.052.012-.053.012-.053.01-.054.01-.053.009-.054.008-.055.006-.055.006-.054.005-.056.003-.055.002-.055.001h-.11l-.055-.003-.055-.003-.055-.005-.055-.005-.054-.007-.054-.008L9.802 11l-.054-.01-.052-.01-.053-.012-.052-.012-.051-.013-.052-.014-.05-.015-.05-.015-.05-.016-.05-.016-.048-.018-.048-.017-.048-.019-.047-.018-.047-.02-.047-.019-.046-.02-.045-.02-.046-.02-.044-.02-.045-.022-.044-.02-.043-.022-.043-.02-.043-.022-.04-.02-.002-.001-.04-.02-.002-.002-.042-.02-.242-.124-.039-.02-.001-.001-.037-.019h-.002l-.037-.019-.002-.001-.036-.018H8.08l-.037-.019-.037-.018-.037-.017-.036-.017-.036-.017-.036-.016-.035-.015-.035-.015-.034-.014-.034-.014-.034-.013-.032-.013-.033-.012-.032-.01-.031-.011-.032-.01-.03-.01-.03-.008-.03-.008-.03-.007-.028-.007-.028-.006-.028-.005-.028-.005-.027-.004-.027-.004-.026-.003-.027-.002-.026-.002L7.138 10h-.104l-.026.002-.026.002-.026.002-.027.003-.027.003-.027.004-.027.005-.028.005-.028.006-.029.006-.029.007-.03.008-.03.008-.03.01-.03.009-.032.01-.032.011-.032.012-.033.012-.033.013-.034.013-.034.014-.034.015-.035.015-.036.016-.036.016-.036.017-.037.018-.037.017-.037.019-.038.018-.039.02-.038.018-.001.001-.038.02h-.001l-.283.145-.043.021-.043.022-.043.021-.043.022-.044.021-.044.021-.045.021-.045.021-.045.02-.046.021-.046.02-.047.02-.047.02-.048.018-.048.019-.048.018-.05.017-.049.017-.05.016-.05.016-.051.014-.052.015-.052.013-.052.012-.053.012-.053.01-.053.01-.054.01-.054.007-.054.007-.055.006-.055.004-.055.004-.055.002-.055.001H3.82l-.055-.003-.055-.003-.055-.004-.054-.006-.054-.006-.054-.008-.054-.008-.053-.01-.053-.01-.053-.012-.052-.012-.051-.013-.051-.014-.051-.014-.05-.016-.05-.016-.05-.016-.048-.017-.048-.018-.048-.018-.048-.019-.047-.019-.046-.02-.046-.02-.046-.02-.045-.02-.045-.02-.044-.02-.044-.022-.044-.021-.043-.021-.042-.021-.043-.022-.042-.02-.041-.022-.041-.02-.082-.043.628-.89.08.04.04.02.04.02.038.02.039.02.038.019.037.018.038.018.037.018.036.017.036.016.036.016.035.016.035.015.034.014.034.014.034.013.033.013.032.011.032.012.032.01.03.01.031.01.03.008.03.008.03.007.028.007.029.006.028.005.027.005.028.005.027.003.026.003.027.003.026.002.026.002h.103l.026-.001.027-.002.026-.002.026-.003.027-.003.027-.004.028-.005.027-.005.029-.006.028-.006.03-.007.029-.008.03-.008.03-.009.03-.01.032-.01.032-.01.032-.012.033-.012.033-.013.034-.013.034-.014.034-.015.035-.015.036-.016.036-.016.036-.017.037-.017.037-.018.037-.018.038-.02.038-.018.038-.02h.002l.037-.019h.002l.24-.124.043-.022.043-.021.042-.021.043-.022.043-.021.044-.022.044-.02.045-.022.045-.02.045-.021.046-.02.046-.02.047-.02.047-.02.048-.019.048-.018.048-.018.05-.018.049-.017.05-.016.05-.016.051-.015.051-.014.052-.013.052-.013.053-.011.053-.011.054-.01.053-.009.055-.008.054-.007.055-.005.054-.005.055-.004.056-.002.055-.001h.11l.055.002.055.003.055.005.054.005.055.007.054.007.053.008.054.01.053.01.052.012.052.012.052.013.051.014.05.014.051.015.05.016.05.017.048.017.048.017.048.019.048.018.047.02.046.019.046.02.046.02.045.02.045.02.044.021.044.021.044.021.043.021.043.021.042.022.042.02.042.022.242.124.04.02.038.02h.002l.036.019h.003l.035.018.003.002.036.018.038.018.037.017.036.017.036.017.036.016.035.016.035.015.034.014.034.014.034.013.033.013.032.011.033.012.031.01.031.01.03.01.031.008.03.008.03.008.028.006.028.007.028.005.028.005.027.004.027.004.027.003.026.003.027.002.026.001.026.001h.077l.026-.001.026-.002.027-.002.026-.003.027-.003.027-.004.027-.004.028-.006.028-.005.029-.007.029-.006.03-.008.029-.008.03-.01.031-.009.031-.01.032-.01.032-.012.033-.012.033-.013.034-.013.034-.014.035-.015.034-.015.036-.016.036-.016.036-.017.037-.017.037-.018.036-.017.038-.019.002-.001.036-.018.002-.001.037-.019h.002l.037-.02h.002l.282-.144v-.001l.043-.021.043-.022.043-.021.043-.022.043-.02.045-.022.044-.021.045-.02.045-.022.046-.02.046-.02.047-.02.047-.02.048-.018.048-.019.048-.018.05-.017.049-.017.05-.017.05-.015.05-.015.052-.015.052-.013.052-.013.053-.011.053-.011.053-.01.054-.01.054-.007.055-.007.054-.006.055-.005.055-.003.055-.003.055-.001z"></path>
            <path d="M10.2 3.758a.5.5 0 0 1 .5.5v10.203a.5.5 0 1 1-1 0V4.258a.5.5 0 0 1 .5-.5"></path>
         </svg>
      </span>
      <span class="text-base inline-richtext"><strong class="font-bold font-sans">Premium EU-made quality</strong> â€” Intense EDP scents lasting 12+ hours</span>
   </li>
   <li class="icon-with-text__item !mb-0">
      <span class="size-8 inline-flex justify-center items-center mr-3">
         <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-accordion icon-return" viewBox="0 0 20 20">
            <path d="M11.571 1.059c0-.309.249-.559.556-.559h1.33C17.07.5 20 3.453 20 7.09s-2.93 6.589-6.543 6.589L1.9 13.71l-.591-.59.59-.572 11.558.013c2.997 0 5.432-2.451 5.432-5.472 0-3.02-2.435-5.471-5.432-5.471h-1.33a.557.557 0 0 1-.556-.56"></path>
            <path d="M6.003 7.007a.553.553 0 0 1 .786.011.56.56 0 0 1-.012.79zM1.31 13.12l5.43 5.426a.56.56 0 0 1 0 .79.553.553 0 0 1-.785 0L.162 13.503a.56.56 0 0 1 .007-.796l3.035-2.965 2.8-2.735.773.801-2.798 2.736c-1.025 1-2.108 2.027-2.67 2.576"></path>
         </svg>
      </span>
      <span class="text-base inline-richtext"><strong class="font-bold font-sans">Try, then decide </strong>â€” 60-day stress-free returns, even after a test spray</span>
   </li>
</ul>

<script>
  document.addEventListener('alpine:init', function() {
  Alpine.store('bundle', {
    package: 'buy_1',
    addGiftBag: false,
    giftVariantId: '{{ gift_product.selected_or_first_available_variant.id }}',
    addingToCart: false,
    variants: {
      buy_1: [
        {% liquid 
          assign first_product = bundle_collection.products[0]
          assign selected_variant = first_product.variants.first
          for v in first_product.variants
            if v.title == '50ML'
              assign selected_variant = v
              break
            endif
          endfor
        %}
        '{{ selected_variant.id }}'
      ],
      buy_2_get_1_free: [
        {% for product in bundle_collection.products limit: 3 %}
          {% liquid 
            assign selected_variant = product.variants.first
            for v in product.variants
              if v.title == '50ML'
                assign selected_variant = v
                break
              endif
            endfor
          %}
          '{{ selected_variant.id }}'{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ],
      buy_3_get_2_free: [
        {% for product in bundle_collection.products limit: 5 %}
          {% liquid 
            assign selected_variant = product.variants.first
            for v in product.variants
              if v.title == '50ML'
                assign selected_variant = v
                break
              endif
            endfor
          %}
          '{{ selected_variant.id }}'{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ]
    },
    
    setPackage(pkg) {
      this.package = pkg;
    },
    
    updateVariant(pkg, index, variantId) {
      this.variants[pkg][index] = variantId;
    },
    
    addToCart() {
        this.addingToCart = true;

        // Clone selected variants to avoid mutating original array
        let selectedVariants = [...this.variants[this.package]];
        
        // Add gift bag if checked
        if (this.addGiftBag && this.giftVariantId) {
          selectedVariants.push(this.giftVariantId);
        }

        const variantCounts = {};
        
        // Count occurrences of each variant
        selectedVariants.forEach(variantId => {
          variantCounts[variantId] = (variantCounts[variantId] || 0) + 1;
        });
        
        // Build cart URL: /cart/variant_id:quantity,variant_id:quantity
        const cartItems = Object.entries(variantCounts).map(([id, qty]) => `${id}:${qty}`);
        const cartUrl = '/cart/' + cartItems.join(',');
        
        // Redirect to cart
        window.location.href = cartUrl;

        setTimeout(() => {
          this.addingToCart = false;
        }, 10000 );
      }
  });
  });
</script>